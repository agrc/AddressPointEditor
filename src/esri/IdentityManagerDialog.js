//>>built
define(["dojo/_base/kernel","dojo/_base/declare","dojo/_base/config","dojo/_base/Deferred","dojo/_base/lang","dojo/has","dojo/dom-attr","dojo/keys","dojo/i18n","dijit/registry","dijit/Dialog","esri/kernel","esri/lang","esri/domUtils","esri/IdentityManagerBase","dojo/i18n!esri/nls/jsapi","dojo/query","dijit/form/Button","dijit/form/ValidationTextBox"],function(e,r,g,s,t,w,i,u,v,j,m,p,n,k,q){return r([q],{declaredClass:"esri.IdentityManager",_eventMap:{"dialog-cancel":["info"]},constructor:function(d){t.mixin(this,d);this.registerConnectEvents()},
_dialogContent:"<div class='dijitDialogPaneContentArea'><div style='padding-bottom: 5px; word-wrap: break-word;'>${info}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>${invalidUser}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><table style='width: 100%;'><tr><td><label>${lblUser}</label><br/><input data-dojo-type='dijit.form.ValidationTextBox' data-dojo-props='type:\"text\", \"class\":\"esriIdUser\", required:true, trim:true, style:\"width: 100%;\"' /></td></tr><tr><td><label>${lblPwd}</label><br/><input data-dojo-type='dijit.form.ValidationTextBox' data-dojo-props='type:\"password\", \"class\":\"esriIdPwd\", required:true, style:\"width: 100%;\"' /></td></tr></table></div><div class='dijitDialogPaneActionBar'><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdSubmit\"'>${lblOk}</button><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdCancel\"'>${lblCancel}</button></div>",
onDialogCreate:function(){},onDialogCancel:function(){},signIn:function(d,b,a){if(!this._nls)this._nls=v.getLocalization("esri","jsapi").identity;if(!this._loginDialog)this._loginDialog=this.dialog=this._createLoginDialog(),this.onDialogCreate();var f=this._loginDialog,l=a&&a.error,e=a&&a.token,c=new s(function(){f.onCancel()});if(f.open)return d=Error("BUSY"),d.code="IdentityManager.1",d.log=g.isDebug,c.errback(d),c;k.hide(f.errMsg_);l&&403==l.code&&e&&(i.set(f.errMsg_,"innerHTML",this._nls.forbidden),
k.show(f.errMsg_));f.dfd_=c;f.serverInfo_=b;f.resUrl_=d;f.admin_=a&&a.isAdmin;i.set(f.resLink_,{title:d,innerHTML:"("+(this.getResourceName(d)||this._nls.lblItem)+")"});i.set(f.serverLink_,{title:b.server,innerHTML:(-1!==b.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":b.server)+" "});f.txtPwd_.set("value","");f.show();return c},_createLoginDialog:function(){var d=this._nls,b=n.substitute(d,this._dialogContent),b=n.substitute({resource:"<span class='resLink' style='word-wrap: break-word;'></span>",
server:"<span class='serverLink' style='word-wrap: break-word;'></span>"},b),a=new m({title:d.title,content:b,"class":"esriSignInDialog",style:"width: 18em;",esriIdMgr_:this,keypressed_:function(a){a.charOrCode===u.ENTER&&this.execute_()},execute_:function(){var a=this.txtUser_.get("value"),b=this.txtPwd_.get("value"),e=this.dfd_,c=this;if(a&&b){this.btnSubmit_.set("label",d.lblSigning);var j=p.id.findCredential(c.resUrl_,a),g=function(b){c.btnSubmit_.set("label",d.lblOk);c.btnSubmit_.set("disabled",
!1);k.hide(c.errMsg_);c.hide();m._DialogLevelManager.hide(c);var l=c.serverInfo_;c.dfd_=c.serverInfo_=c.generateDfd_=c.resUrl_=null;var g,i,h=j,o;if(b)g=b.token,i=n.isDefined(b.expires)?Number(b.expires):null,o=!!b.ssl,h?(h.userId=a,h.token=g,h.expires=i,h.validity=b.validity,h.ssl=o,h.creationTime=(new Date).getTime()):h=new q.Credential({userId:a,server:l.server,token:g,expires:i,ssl:o,isAdmin:c.admin_,validity:b.validity});e.callback(h)};j&&!j._enqueued?g():(c.btnSubmit_.set("disabled",!0),c.generateDfd_=
p.id.generateToken(this.serverInfo_,{username:a,password:b},{isAdmin:this.admin_}).addCallback(g).addErrback(function(a){c.btnSubmit_.set("disabled",!1);c.generateDfd_=null;c.btnSubmit_.set("label",d.lblOk);i.set(c.errMsg_,"innerHTML",a&&a.code?d.invalidUser:d.noAuthService);k.show(c.errMsg_)}))}},cancel_:function(){a.generateDfd_&&a.generateDfd_.cancel();var b=a.dfd_,d=a.resUrl_,e=a.serverInfo_;a.btnSubmit_.set("disabled",!1);a.dfd_=a.serverInfo_=a.generateDfd_=a.resUrl_=null;k.hide(a.errMsg_);m._DialogLevelManager.hide(a);
a.esriIdMgr_.onDialogCancel({resourceUrl:d,serverInfo:e});d=Error("ABORTED");d.code="IdentityManager.2";d.log=g.isDebug;b.errback(d)}}),b=a.domNode;a.txtUser_=j.byNode(e.query(".esriIdUser",b)[0]);a.txtPwd_=j.byNode(e.query(".esriIdPwd",b)[0]);a.btnSubmit_=j.byNode(e.query(".esriIdSubmit",b)[0]);a.btnCancel_=j.byNode(e.query(".esriIdCancel",b)[0]);a.resLink_=e.query(".resLink",b)[0];a.serverLink_=e.query(".serverLink",b)[0];a.errMsg_=e.query(".esriErrorMsg",b)[0];a.connect(a.txtUser_,"onKeyPress",
a.keypressed_);a.connect(a.txtPwd_,"onKeyPress",a.keypressed_);a.connect(a.btnSubmit_,"onClick",a.execute_);a.connect(a.btnCancel_,"onClick",a.onCancel);a.connect(a,"onCancel",a.cancel_);return a}})});