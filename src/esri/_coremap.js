//>>built
define(["require","dojo/_base/kernel","dojo/_base/declare","dojo/_base/connect","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/array","dojo/_base/event","dojo/_base/unload","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/sniff","dijit/registry","dojox/gfx/matrix","esri/kernel","esri/config","esri/lang","esri/Evented","esri/fx","esri/deferredUtils","esri/tileUtils","esri/geometry/Point","esri/geometry/ScreenPoint","esri/geometry/Extent","esri/geometry/Rect","esri/geometry/mathUtils","esri/geometry/scaleUtils","esri/geometry/screenUtils","esri/geometry/webMercatorUtils","esri/layers/GraphicsLayer","esri/layers/TileInfo","esri/layers/LOD","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/OpenStreetMapLayer","esri/dijit/Popup","dojo/uacss"],
function(U,ca,da,u,V,C,j,ea,fa,ga,ha,Q,M,O,P,R,W,ia,sa,ja,q,ka,X,la,Y,H,D,v,I,ma,J,Z,S,z,na,oa,pa,qa,ra){function $(a,b){var c=a.lods;c.sort(function(a,b){return a.scale>b.scale?-1:a.scale<b.scale?1:0});var d=[],c=j.filter(c,function(a){if(-1===K(d,a.scale))return d.push(a.scale),!0}),e=b.lods=[],f;j.forEach(c,function(a,b){f=e[b]=new oa(a);f.level=b});b.tileInfo=new na(A(a,{lods:e}))}var N=Z.toMapPoint,T=Z.toScreenPoint,L=u.connect,E=u.disconnect,G=C.hitch,x=P.set,K=j.indexOf,A=C.mixin,aa=0,o=ja.defaults.map;
return da([ka],{declaredClass:"esri._CoreMap",resizeDelay:300,invalidExtent:"Map does not have a valid extent.",invalidGeometry:"Geometry (wkid: ${geometry}) cannot be converted to spatial reference of the map (wkid: ${map})",unknownBasemap:'Unable to find basemap definition for: "${basemapName}". Try one of these: ${list}',invalidBasemap:'Unable to add basemap: "${basemapName}".',unknownLayerType:'Unknown basemap layer type: "${type}" found in basemap definition for: "${basemapName}".',visible:!0,
_eventMap:{"basemap-change":!0,"extent-change":["extent","delta","levelChange","lod"],"layer-add":["layer"],"layer-add-result":["layer","error"],"layer-remove":["layer"],"layer-reorder":["layer","index"],"layer-resume":["layer"],"layer-suspend":["layer"],"layers-add-result":["layers"],"layers-removed":!0,"layers-reordered":["layerIds"],load:["map"],pan:["extent","delta"],"pan-end":["extent","delta"],"pan-start":["extent","screenPoint"],reposition:["x","y"],resize:["extent","width","height"],scale:["matrix",
"immediate"],"time-extent-change":["timeExtent"],unload:["map"],"update-end":["error"],"update-start":!0,zoom:["extent","zoomFactor","anchor"],"zoom-end":["extent","zoomFactor","anchor","level"],"zoom-start":["extent","zoomFactor","anchor","level"],click:!0,"dbl-click":!0,"key-down":!0,"key-up":!0,"mouse-down":!0,"mouse-drag":!0,"mouse-drag-end":!0,"mouse-drag-start":!0,"mouse-move":!0,"mouse-out":!0,"mouse-over":!0,"mouse-up":!0,"mouse-wheel":!0,"basic-tap":!0,"double-tap":!0,"pinch-end":!0,"pinch-move":!0,
"pinch-start":!0,"processed-double-tap":!0,"processed-tap":!0,"swipe-end":!0,"swipe-move":!0,"swipe-start":!0,tap:!0,"two-finger-tap":!0},constructor:function(a,b){this.registerConnectEvents();A(this,{_internalLayerIds:[],_layers:[],_layerDivs:[],_layerSize:0,_clickHandles:[],_connects:[]});A(this,{_zoomAnimDiv:null,_zoomAnim:null,_layersDiv:null,_firstLayerId:null,_delta:null,_cursor:null,_ratioW:1,_ratioH:1,_params:null});A(this,{cursor:null,layerIds:[],graphicsLayerIds:[],graphics:null,loaded:!1});
A(this,{__panning:!1,__zooming:!1,__container:null,root:null,__LOD:null,__tileInfo:null,__visibleRect:null,__visibleDelta:null});this._rids=[];var c=this.container=ga.byId(a),d=this.id=ha.get(c,"id")||W.getUniqueId(this.declaredClass);Q.add(c,"map");var e=O.getContentBox(c),f=Q.add,g=M.create;this.position=new D(0,0);this._reposition();var h=this.width=e.w||o.width,i=this.height=e.h||o.height;0===e.w&&x(c,"width",h+"px");0===e.h&&x(c,"height",i+"px");var k=this.root=g("div",{id:d+"_root",style:{width:h+
"px",height:i+"px",direction:"ltr"}});f(k,"container");e=this.__container=g("div",{id:d+"_container"},k);x(e,"position","absolute");f(e,"container");c.appendChild(k);c=this._params=A({slider:!0,nav:!1,zoom:-1,minZoom:-1,maxZoom:-1,scale:-1,minScale:0,maxScale:0,showInfoWindowOnClick:!0,displayGraphicsOnPan:!0,wrapAround180:!0,fitExtent:!1},b||{});this.wrapAround180=c.wrapAround180;if(q.isDefined(c.resizeDelay))this.resizeDelay=c.resizeDelay;if(c.lods)$({rows:512,cols:512,dpi:96,format:"JPEG",compressionQuality:75,
origin:{x:-180,y:90},spatialReference:{wkid:4326},lods:c.lods},c),this.__tileInfo=c.tileInfo;this.extent=c.extent;this._extentUtil({mapCenter:c.center,targetLevel:c.zoom,targetScale:c.scale});this.__visibleRect=new I(0,0,h,i);this.__visibleDelta=new I(0,0,h,i);d=this._layersDiv=g("div",{id:d+"_layers"});f(d,"layersDiv");e.appendChild(d);this._zoomAnimDiv=g("div",{style:{position:"absolute"}});c.infoWindow?this.infoWindow=c.infoWindow:(f=this.infoWindow=new ra(c.popupOptions,g("div")),f.startup(),
f._ootb=!0,x(f.domNode,"zIndex",40));this._zoomStartHandler=G(this,this._zoomStartHandler);this._zoomingHandler=G(this,this._zoomingHandler);this._zoomEndHandler=G(this,this._zoomEndHandler);this._panningHandler=G(this,this._panningHandler);this._panEndHandler=G(this,this._panEndHandler);this._endTranslate=G(this,this._endTranslate);fa.addOnWindowUnload(this,this.destroy)},_cleanUp:function(){var a=this.infoWindow;a&&(a._ootb&&a.destroy?a.destroy():a.unsetMap(this),delete this.infoWindow);E(this._tsTimeExtentChange_connect);
this.setInfoWindowOnClick(!1);M.destroy(this.root);this.root=null},_addLayer:function(a,b,c){var d=a.id=a.id||(a instanceof z?o.graphicsLayerNamePrefix:o.layerNamePrefix)+aa++;this._layers[d]=a;var e,f;if(b===this.layerIds||b===this.graphicsLayerIds)e=this._layerSize,this._layerSize++;a._isRefLayer="top"===c;c=!q.isDefined(c)||0>c||c>b.length||"top"===c?b.length:c;if(0===e)this._firstLayerId=d;if(!a._isRefLayer)for(;(f=this.getLayer(b[c-1]))&&f._isRefLayer;)c--;b.splice(c,0,d);var g=G(this,this._addLayerHandler),
h=this,c=this._connects;f=function(){a.loaded?h._onLoadFix?(h._onLoadFix=!1,setTimeout(function(){g(a)},0)):g(a):(h[d+"_addtoken_load"]=L(a,"onLoad",h,"_addLayerHandler"),h[d+"_addtoken_err"]=L(a,"onError",h,function(c){g(a,c,b)}))};this.loaded||0===e||a.loaded&&-1===K(this.graphicsLayerIds,d)?f():c.push(L(this,"onLoad",f));return a},_addLayerHandler:function(a,b,c){var d=this.id,e=a.id,f=K(a instanceof z?this.graphicsLayerIds:this.layerIds,e),g=f,h=!1,i=this._params;E(this[e+"_addtoken_load"]);E(this[e+
"_addtoken_err"]);if(b)delete this._layers[e],-1!==f&&(c.splice(f,1),this.onLayerAddResult(a,b));else{-1===f&&(f=K(this._internalLayerIds,e),g=20+f,h=!0);if(e===this._firstLayerId){b=a.spatialReference;if((c=this.extent&&this.extent.spatialReference)&&!c.equals(b)&&(a.tileInfo||!a.url))c=null;c=this.spatialReference=c||b;this.wrapAround180=this.wrapAround180&&c&&c._isWrappable()?!0:!1;if(a.tileInfo)this.__tileInfo?(b=this.__tileInfo.lods,this.__tileInfo=A({},a.tileInfo),this.__tileInfo.lods=b):($(A({},
a.tileInfo),i),this.__tileInfo=i.tileInfo);if(this.wrapAround180){b=this.__tileInfo;c=c._getInfo();if(!b||Math.abs(c.origin[0]-b.origin.x)>c.dx)this.wrapAround180=!1;this.wrapAround180&&b&&Y._addFrameInfo(b,c)}i.units=a.units;if((b=this.__tileInfo&&this.__tileInfo.lods)&&b.length){var c=i.minScale,f=i.maxScale,k=-1,y=-1,l=!1,ba=!1,n;for(n=0;n<b.length;n++){if(0<c&&!l&&c>=b[n].scale)k=b[n].level,l=!0;0<f&&!ba&&f>=b[n].scale&&(y=0<n?b[n-1].level:-1,ba=!0)}if(-1===i.minZoom)i.minZoom=0===c?b[0].level:
k;if(-1===i.maxZoom)i.maxZoom=0===f?b[b.length-1].level:y;for(n=0;n<b.length;n++){if(i.minZoom===b[n].level)i.minScale=b[n].scale;if(i.maxZoom===b[n].level)i.maxScale=b[n].scale}}else i.minZoom=i.maxZoom=i.zoom=-1}if(a instanceof z){if(!this._gc)this._gc=new z._GraphicsContainer,this._gc._setMap(this,this._layersDiv).id=d+"_gc";g=a._setMap(this,this._gc._surface);g.id=d+"_"+e;this._layerDivs[e]=g;this._reorderLayers(this.graphicsLayerIds);i.showInfoWindowOnClick&&this._clickHandles.push(L(a,"onClick",
this,"_gClickHandler"))}else g=a._setMap(this,this._layersDiv,g,this.__LOD),g.id=d+"_"+e,this._layerDivs[e]=g,this._reorderLayers(this.layerIds),!h&&-1!==a.declaredClass.indexOf("VETiledLayer")&&this._onBingLayerAdd(a);if(e===this._firstLayerId)this.graphics=new z({id:d+"_graphics",displayOnPan:i.displayGraphicsOnPan}),this._addLayer(this.graphics,this._internalLayerIds,20);if(a===this.graphics){c=this._layers[this._firstLayerId];d=i.zoom;g=i.scale;b=i.center;c=c.initialExtent||c.fullExtent;this._firstLayerId=
null;if(this.extent)this.extent=this._convertGeometry(this,this.extent);!this.extent&&c&&(b&&(b=this._convertGeometry(c,b)),b&&(c=c.centerAt(b)));if(b=this.extent||c&&new v(c.toJson()))-1<d?b=this.__getExtentForLevel(d,null,b).extent:0<g&&(b=J.getExtentForScale(this,g,b));if(!b){console.log("Map: "+this.invalidExtent);return}d=this._fixExtent(b,i.fitExtent);this.extent=d.extent;this.__LOD=d.lod;this.__setExtent(this.extent,null,null,i.fitExtent);this.loaded=!0;this.infoWindow.setMap(this);this.onLoad(this)}h||
(this.onLayerAdd(a),this.onLayerAddResult(a));E(this[e+"_addLayerHandler_connect"])}},_convertGeometry:function(a,b){var c=a&&a.spatialReference,d=b&&b.spatialReference;c&&d&&!c.equals(d)&&(c._canProject(d)?c.isWebMercator()?b=S.geographicToWebMercator(b):4326===c.wkid&&(b=S.webMercatorToGeographic(b,!0)):(console.log("Map: "+q.substitute({geometry:d.wkid||d.wkt,map:c.wkid||c.wkt},this.invalidGeometry)),b=null));return b},_reorderLayers:function(a){var b=this.onLayerReorder,c=M.place,d=this._layerDivs,
e=this._layers,f=this._gc?this._gc._surface.getEventSource():null;if(a===this.graphicsLayerIds)j.forEach(a,function(a,g){var h=d[a];h&&(c(h.getEventSource(),f,g),b(e[a],g))});else{var g=this.graphics,h=g?g.id:null,i=this._layersDiv,k;j.forEach(a,function(a,f){k=d[a];a!==h&&k&&(c(k,i,f),b(e[a],f))});f&&(f=9>R("ie")?f.parentNode:f,c(f,f.parentNode,a.length))}this.onLayersReordered([].concat(a))},_zoomStartHandler:function(){this.__zoomStart(this._zoomAnimDiv.startingExtent,this._zoomAnimDiv.anchor)},
_zoomingHandler:function(a){var b=parseFloat(a.left),c=parseFloat(a.top),a=new v(b,c-parseFloat(a.height),b+parseFloat(a.width),c,this.spatialReference),b=this.extent.getWidth()/a.getWidth();this.__zoom(a,b,this._zoomAnimDiv.anchor)},_zoomEndHandler:function(){var a=this._zoomAnimDiv,b=a.extent,c=this.extent.getWidth()/b.getWidth(),d=a.anchor,e=a.newLod,f=a.levelChange;a.extent=a.anchor=a.levelChange=a.startingExtent=a.newLod=this._delta=this._zoomAnim=null;this.__zoomEnd(b,c,d,e,f)},_panningHandler:function(a){if(isNaN(parseFloat(a.left))||
isNaN(parseFloat(a.top))){var b=Math.round,c=this._panAnim.node;a.left=-1*(this._delta.x-b(this.width/2))+"px";a.top=-1*(this._delta.y-b(this.height/2))+"px";P.set(c,"left",a.left);P.set(c,"top",a.top)}a=new D(parseFloat(a.left),parseFloat(a.top));b=this.toMap(a);this.onPan(this.extent.offset(b.x,b.y),a)},_panEndHandler:function(a){this.__panning=!1;var b=Math.round,a=new D(-b(parseFloat(a.style.left)),-b(parseFloat(a.style.top))),b=a.x,c=a.y,d=this.__visibleRect,e=this.__visibleDelta;d.x+=-b;d.y+=
-c;e.x+=-b;e.y+=-c;x(this._zoomAnimDiv,{left:"0px",top:"0px"});var d=this.extent,e=this._ratioW,f=this._ratioH,d=new v(d.xmin+b/e,d.ymin-c/f,d.xmax+b/e,d.ymax-c/f,this.spatialReference);a.setX(-a.x);a.setY(-a.y);this._delta=this._panAnim=null;this._updateExtent(d);this.onPanEnd(d,a);this._fireExtChg([d,a,!1,this.__LOD])},_fixExtent:function(a,b){for(var c=this._reshapeExtent(a),d=1.25;!0===b&&(c.extent.getWidth()<a.getWidth()||c.extent.getHeight()<a.getHeight())&&0<c.lod.level&&3>=d;)c=this._reshapeExtent(a.expand(d)),
d+=0.25;return c},_getFrameWidth:function(){var a=-1,b=this.spatialReference._getInfo();this.__LOD?(b=this.__LOD._frameInfo)&&(a=b[3]):b&&(a=Math.round(2*b.valid[1]/(this.extent.getWidth()/this.width)));return a},_reshapeExtent:function(a){var b=a.getWidth(),c=a.getHeight(),d=b/c,e=this.width/this.height,f=0,g=0;this.width>this.height?b>c?e>d?f=c*e-b:g=b/e-c:f=c*e-b:this.width<this.height?b>c?g=b/e-c:b<c?e>d?f=c*e-b:g=b/e-c:g=b/e-c:b<c?f=c-b:b>c&&(g=b/e-c);f&&(a.xmin-=f/2,a.xmax+=f/2);g&&(a.ymin-=
g/2,a.ymax+=g/2);return this._getAdjustedExtent(a)},_getAdjustedExtent:function(a){if(this.__tileInfo)return Y.getCandidateTileInfo(this,this.__tileInfo,a);var b=J.getScale(this,a),c=this.getMinScale(),d=this.getMaxScale();!c||b<=c?!d||b>=d||(a=J.getExtentForScale(this,d,a)):a=J.getExtentForScale(this,c,a);return{extent:a}},_gClickHandler:function(a){var b=a.graphic,c=this.infoWindow;if(b._getEffInfoTemplate()&&c){ea.stop(a);var d=b.geometry,a=d&&"point"===d.type?d:a.mapPoint;if(c.setFeatures)c.setFeatures([b]);
else{c.setTitle(b.getTitle());if((b=b.getContent())&&C.isString(b.id))(d=W.byId(b.id))&&d.set&&/_PopupRenderer/.test(d.declaredClass)&&d.set("showTitle",!1);c.setContent(b)}c.show(a)}},_onBingLayerAdd:function(a){this["__"+a.id+"_vis_connect"]=u.connect(a,"onVisibilityChange",this,"_toggleBingLogo");this._toggleBingLogo(a.visible)},_onBingLayerRemove:function(a){u.disconnect(this["__"+a.id+"_vis_connect"]);delete this["__"+a.id+"_vis_connect"];this._toggleBingLogo(j.some(this.layerIds,function(a){return(a=
this._layers[a])&&a.visible&&-1!==a.declaredClass.indexOf("VETiledLayer")},this))},_toggleBingLogo:function(a){if(a&&!this._bingLogo){a={left:this._mapParams&&this._mapParams.nav?"25px":""};if(6===R("ie"))a.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled='true', sizingMethod='crop', src='"+U.toUrl("esri")+"/images/map/bing-logo-lg.png')";a=this._bingLogo=M.create("div",{style:a},this.root);Q.add(a,"bingLogo-lg")}else!a&&this._bingLogo&&(M.destroy(this._bingLogo),delete this._bingLogo)},
__panStart:function(a,b){var c=this._zoomAnim,d=this._panAnim;if(c&&c._active)c.stop(),c._fire("onEnd",[c.node]);else if(d&&d._active){d.stop();this._panAnim=null;var d=d.curve.getValue(d._getStep()),c=Math.round(parseFloat(d.left)),d=Math.round(parseFloat(d.top)),e=this.navigationManager._dragOrigin;this.__pan(c,d);e&&(e.x-=c,e.y-=d);return}this.__panning=!0;this.onPanStart(this.extent,new D(a,b))},__pan:function(a,b){var c=this.extent,d=this._ratioW,e=this._ratioH;this.onPan(new v(c.xmin-a/d,c.ymin+
b/e,c.xmax-a/d,c.ymax+b/e,this.spatialReference),new D(a,b))},__panEnd:function(a,b){var c=this.__visibleRect,d=this.__visibleDelta;c.x+=a;c.y+=b;d.x+=a;d.y+=b;var c=new D(a,b),d=this.extent,e=this._ratioW,f=this._ratioH,d=new v(d.xmin-a/e,d.ymin+b/f,d.xmax-a/e,d.ymax+b/f,this.spatialReference);this.__panning=!1;this._updateExtent(d);this.onPanEnd(d,c);this._fireExtChg([d,c,!1,this.__LOD])},__zoomStart:function(a,b){this.__zooming=!0;this.onZoomStart(a,1,b,this.__LOD?this.__LOD.level:null)},__zoom:function(a,
b,c){this.onZoom(a,b,c)},__zoomEnd:function(a,b,c,d,e){x(this._layersDiv,{left:"0px",top:"0px"});this._delta=new D(0,0);this.__visibleRect.x=this.__visibleRect.y=0;a=new v(a);this.__LOD=d;this._ratioW=this.width/a.getWidth();this._ratioH=this.height/a.getHeight();var f=this._delta;this._delta=null;this.__zooming=!1;this._updateExtent(a,e);this.onZoomEnd(a,b,c,d?d.level:null);this._fireExtChg([a,f,e,d])},_extentUtil:function(a,b,c,d,e){var f=new V,g,h,i,k,y,l,j,n,r,t,p=this.width,m=this.height,o,w,
s;if(a)g=a.numLevels,h=a.targetLevel,o=q.isDefined(h),i=a.factor,k=a.mapAnchor,y=a.screenAnchor,l=a.mapCenter,w=a.levelOrFactor,j=a.targetScale,n=q.isDefined(j)&&0<j;if(b)r=b.dx,t=b.dy,l=b.mapCenter;C.isArray(l)&&(l=new H(l));var u=this._panAnim,b=(a=this._stopAnim())?a.divExtent:this.extent,x=this.__tileInfo,B=this._params;if(!this.loaded){if(c){if(b&&(c=this._convertGeometry(b,c)),c)this.extent=c,B.zoom=B.scale=-1,B.center=null}else if(l||o||n){if(l)if(b){if(l=this._convertGeometry(b,l))this.extent=
b.centerAt(l),B.center=null}else B.center=l;if(o&&-1<h)B.zoom=h,B.scale=-1;else if(n)B.scale=j,B.zoom=-1}f.resolve();return f}if(l&&(l=this._convertGeometry(this,l),!l)||k&&(k=this._convertGeometry(this,k),!k))return f.reject(),f;if(c&&(c=this._convertGeometry(this,c),!c))return f.reject(),f;u&&k&&y&&(k=N(this.extent,p,m,y));a&&k&&y&&(k=N(a.divExtent,p,m,y));o&&(x?(g=this.getMinZoom(),o=this.getMaxZoom(),h<g?h=g:h>o&&(h=o),g=h-(a?a.level:this.getLevel())):(g=0<h?-1:1,s=w?h:null));if(!c)if(q.isDefined(g))x?
m=this.__getExtentForLevel((a?a.level:this.getLevel())+g,l,b).extent:(m=(a?a.end:this.extent).expand(s||(0<g?0.5*g:2*-g)),s&&l&&(m=m.centerAt(l))),m&&(l?c=m:(p=k||b.getCenter(),r=b.ymax-(m.getHeight()-b.getHeight())*(p.y-b.ymax)/b.getHeight(),p=b.xmin-(m.getWidth()-b.getWidth())*(p.x-b.xmin)/b.getWidth(),c=new v(p,r-m.getHeight(),p+m.getWidth(),r,this.spatialReference)));else if(n)c=J.getExtentForScale(this,j,b);else if(q.isDefined(i))c=b.expand(i);else if(r||t)a?(c=a.end,k=c.getCenter(),s=T(c,p,
m,k),s.x+=r,s.y+=t,s=N(c,p,m,s),c=c.offset(s.x-k.x,s.y-k.y)):(r=new D(p/2+r,m/2+t),t=N(b,p,m,r),m=b.getWidth(),r=b.getHeight(),p=t.x-m/2,t=t.y-r/2,c=new v(p,t,p+m,t+r,this.spatialReference));if(!c)if(l)b=a?a.end:b,m=b.getWidth(),r=b.getHeight(),p=l.x-m/2,t=l.y-r/2,c=new v(p,t,p+m,t+r,this.spatialReference);else if(a)c=a.end;c?(this._extentDfd&&-1===this._extentDfd.fired&&this._extentDfd.reject(),this._extentDfd=f,this.__setExtent(c,null,y,d,a,e)):f.reject();return f},__setExtent:function(a,b,c,d,
e,f){try{if(this._firstLayerId)this.extent=a;else{var g=!0,h=this.spatialReference,i=e?e.divExtent:this.extent,k=this._fixExtent(a,d||!1),a=k.extent,y=a.getWidth(),l=a.getHeight(),j=Math.round;if(i)var n=j(1E6*i.getWidth()),r=j(1E6*y),t=j(1E6*i.getHeight()),p=j(1E6*l),g=n!==r||t!==p;var m,q,w=e&&e.rect,s=e&&e.divExtent;if(o.zoomDuration&&g&&i){s=s||new v(i);w=w||{left:i.xmin,top:i.ymax,width:i.getWidth(),height:i.getHeight()};q={left:a.xmin,top:a.ymax,width:y,height:l};var u=new H(a.xmin,a.ymax,h),
z=new H(a.xmin,a.ymin,h),B=new H(this.extent.xmin,this.extent.ymax,h),C=new H(this.extent.xmin,this.extent.ymin,h);m=ma.getLineIntersection(B,u,C,z,h);!m&&!e&&(g=!1)}this._ratioW=this.width/y;this._ratioH=this.height/l;var F=this._zoomAnimDiv;if(g)x(this._layersDiv,{left:"0px",top:"0px"}),b=new D(0,0),this.__visibleRect.x=this.__visibleRect.y=0,w&&q?(this._delta=b,F.id="_zAD",F.startingExtent=s,F.extent=a,F.levelChange=g,F.newLod=k.lod,F.anchor=c?c:!m&&e?e.anchor:T(this.extent,this.width,this.height,
m),this._zoomAnim=X.resize({node:F,start:w,end:q,duration:o.zoomDuration,rate:o.zoomRate,beforeBegin:!e?this._zoomStartHandler:null,onAnimate:this._zoomingHandler,onEnd:this._zoomEndHandler}).play(),this._fireOnScale(this.extent.getWidth()/a.getWidth(),F.anchor)):(this._updateExtent(a,g),this._fireExtChg([this.extent,b,g,this.__LOD=k.lod]));else if(!this.__panning)if(!1===this.loaded||f)this._updateExtent(a,g),this._fireExtChg([this.extent,b,g,this.__LOD=k.lod]);else{this.__panning=!0;w=(new I(0,
0,this.width,this.height,this.spatialReference)).getCenter();w.x=j(w.x);w.y=j(w.y);this.onPanStart(this.extent,new D(0,0));var A=this._delta=this.toScreen(a.getCenter());this._panAnim=X.slideTo({node:F,left:w.x-A.x,top:w.y-A.y,duration:o.panDuration,rate:o.panRate,onAnimate:this._panningHandler,onEnd:this._panEndHandler});this._panAnim.play()}}}catch(E){console.log(E.stack),console.error(E)}},_fireOnScale:function(a,b,c){if("css-transforms"===this.navigationMode){var d=this.__visibleDelta;this.onScale(ia.scaleAt(a,
{x:-1*(this.width/2-(b.x-d.x)),y:-1*(this.height/2-(b.y-d.y))}),c)}},_stopAnim:function(){var a=this._zoomAnim,b=this._panAnim;if(a&&a._active){a.stop();var b=a.curve.getValue(a._getStep()),c=parseFloat(b.left),d=parseFloat(b.top),a=a.node;return{anchor:a.anchor,start:a.startingExtent,end:a.extent,level:a.newLod&&a.newLod.level,rect:b,divExtent:new v(c,d-parseFloat(b.height),c+parseFloat(b.width),d,this.spatialReference)}}b&&b._active&&(b.stop(),b._fire("onEnd",[b.node]))},__getExtentForLevel:function(a,
b,c){var d=this.__tileInfo,d=d&&d.lods,a=q.isDefined(a)?a:0,c=c||this.extent,b=b||c&&c.getCenter();if(d){if(!b){console.log("Map: "+this.invalidExtent);return}var c=this.getMinZoom(),e=this.getMaxZoom();a>e&&(a=e);a<c&&(a=c);a=d[a];d=this.width*a.resolution/2;c=this.height*a.resolution/2;return{extent:new v(b.x-d,b.y-c,b.x+d,b.y+c,b.spatialReference),lod:a}}if(c)return{extent:c.expand(!a||1>a?1:a).centerAt(b)};console.log("Map: "+this.invalidExtent)},_jobs:0,_incr:function(){if(1===++this._jobs)this.updating=
!0,this.onUpdateStart()},_decr:function(){var a=--this._jobs;if(a){if(0>a)this._jobs=0}else this.updating=!1,this.onUpdateEnd()},_fireEvent:function(a,b){this[a]&&this[a].apply(this,b)},_updateExtent:function(a,b){this.extent=a;b&&this._setClipRect();var c=this.spatialReference;if(c)if(c.isWebMercator())this.geographicExtent=S.webMercatorToGeographic(this._getAvailExtent(),!0);else if(4326===c.wkid)this.geographicExtent=new v(this._getAvailExtent().toJson())},_fireExtChg:function(a){this._fireEvent("onExtentChange",
a);if(a=this._extentDfd)delete this._extentDfd,a.resolve()},onUpdateStart:function(){},onUpdateEnd:function(){},onLoad:function(){this._setClipRect()},onUnload:function(){},onExtentChange:function(){},onTimeExtentChange:function(){},onLayerAdd:function(){},onLayerAddResult:function(){},onLayersAddResult:function(){},onLayerRemove:function(){},onLayersRemoved:function(){},onLayerReorder:function(){},onLayersReordered:function(){},onLayerSuspend:function(){},onLayerResume:function(){},onPanStart:function(){},
onPan:function(){},onPanEnd:function(){},onScale:function(){},onZoomStart:function(){},onZoom:function(){},onZoomEnd:function(){},onResize:function(){this._setClipRect()},onReposition:function(){},destroy:function(){if(!this._destroyed)this.removeAllLayers(),this._cleanUp(),this._gc&&this._gc._cleanUp(),this._destroyed=!0,this.onUnload(this)},setCursor:function(a){x(this.__container,"cursor",this.cursor=a)},setMapCursor:function(a){this.setCursor(this._cursor=a)},resetMapCursor:function(){this.setCursor(this._cursor)},
setInfoWindow:function(a){var b=this.infoWindow;b&&b.unsetMap(this);this.infoWindow=a;this.loaded&&a&&a.setMap(this)},setInfoWindowOnClick:function(a){var b=this._params;if(a){if(!b.showInfoWindowOnClick){var c=[this.graphics].concat(j.map(this.graphicsLayerIds,this.getLayer,this));j.map(c,function(a){a&&a.loaded&&this._clickHandles.push(L(a,"onClick",this,"_gClickHandler"))},this)}}else j.forEach(this._clickHandles,E),this._clickHandles=[];b.showInfoWindowOnClick=a},getInfoWindowAnchor:function(a){return this.infoWindow&&
this.infoWindow._getAnchor&&this.infoWindow._getAnchor(a)||"upperright"},toScreen:function(a,b){return T(this.extent,this.width,this.height,a,b)},toMap:function(a){return N(this.extent,this.width,this.height,a)},addLayer:function(a,b){a&&!this.getLayer(a.id)&&this._addLayer(a,a instanceof z?this.graphicsLayerIds:this.layerIds,b);return a},addLayers:function(a){var b=[],c=a.length,d,e,f=a.length;d=u.connect(this,"onLayerAddResult",function(e,f){-1!==j.indexOf(a,e)&&(c--,b.push({layer:e,success:!f,
error:f}),c||(u.disconnect(d),this.onLayersAddResult(b)))});for(e=0;e<f;e++)this.addLayer(a[e]);return this},removeLayer:function(a,b){var c=a.id,d=a instanceof z?this.graphicsLayerIds:this.layerIds,e=K(d,c);0<=e&&(d.splice(e,1),a instanceof z?(E(this["_gl_"+a.id+"_click_connect"]),a.loaded&&a._unsetMap(this,this._gc._surface)):a.loaded&&(a._unsetMap(this,this._layersDiv),-1!==a.declaredClass.indexOf("VETiledLayer")&&this._onBingLayerRemove(a)),delete this._layers[c],delete this._layerDivs[c],b||
this._reorderLayers(d),this.onLayerRemove(a))},removeAllLayers:function(){var a=this.layerIds,b;for(b=a.length-1;0<=b;b--)this.removeLayer(this._layers[a[b]],1);a=this.graphicsLayerIds;for(b=a.length-1;0<=b;b--)this.removeLayer(this._layers[a[b]],1);this.onLayersRemoved()},reorderLayer:function(a,b){C.isString(a)&&(ca.deprecated(this.declaredClass+": Map.reorderLayer(/*String*/ id, /*Number*/ index) deprecated. Use Map.reorderLayer(/*Layer*/ layer, /*Number*/ index).",null,"v2.0"),a=this.getLayer(a));
var c=a.id,d,e=a instanceof z?this.graphicsLayerIds:this.layerIds;0>b?b=0:b>=e.length&&(b=e.length-1);d=K(e,c);-1===d||d===b||(e.splice(d,1),e.splice(b,0,c),this._reorderLayers(e))},getLayer:function(a){return this._layers[a]},setExtent:function(a,b){var a=new v(a.toJson()),c=a.getWidth(),d=a.getHeight();return 0===c&&0===d?this.centerAt(new H({x:a.xmin,y:a.ymin,spatialReference:a.spatialReference&&a.spatialReference.toJson()})):this._extentUtil(null,null,a,b)},centerAt:function(a){return this._extentUtil(null,
{mapCenter:a})},centerAndZoom:function(a,b){return this._extentUtil({targetLevel:b,mapCenter:a,levelOrFactor:!0})},getScale:function(){return this.__LOD?this.__LOD.scale:J.getScale(this)},getMinScale:function(){return this._params.minScale},getMaxScale:function(){return this._params.maxScale},setScale:function(a){return this._extentUtil({targetScale:a})},getLayersVisibleAtScale:function(a){var b=[];(a=a||this.getScale())&&j.forEach(this.layerIds.concat(this.graphicsLayerIds),function(c){c=this.getLayer(c);
c.isVisibleAtScale(a)&&b.push(c)},this);return b},getNumLevels:function(){var a=this.getMinZoom(),b=this.getMaxZoom();return a===b&&0>a?0:b-a+1},getLevel:function(){return this.__LOD?this.__LOD.level:-1},setLevel:function(a){if(-1<a)return this._extentUtil({targetLevel:a})},getZoom:function(){return this.getLevel()},setZoom:function(a){return this.setLevel(a)},getMinZoom:function(){return this._params.minZoom},getMaxZoom:function(){return this._params.maxZoom},setBasemap:function(a){var b;C.isObject(a)?
(b=a,a=b.title):b=o.basemaps&&o.basemaps[a];if(b){this._basemapDfd&&-1===this._basemapDfd.fired&&this._basemapDfd.cancel();var c=[],d=[],e=0;j.forEach(b.baseMapLayers||b.layers,function(b){var f,g={id:b.id,displayLevels:b.displayLevels,opacity:q.isDefined(b.opacity)?b.opacity:null,visible:q.isDefined(b.visibility)?b.visibility:null};if(b.type)switch(b.type){case "OpenStreetMap":f=new qa(g);break;default:console.log("Map.setBasemap: "+q.substitute({basemapName:a,type:b.type},this.unknownLayerType))}else{f=
b.url;if("https:"===window.location.protocol&&(-1!==f.search(/^http\:\/\/server\.arcgisonline\.com/i)||-1!==f.search(/^http\:\/\/services\.arcgisonline\.com/i)||-1!==f.search(/^http\:\/\/.+\.arcgis\.com/i)))f=f.replace(/http:/i,"https:");f=new pa(f,g)}f&&(c.push(f),d.push(b),b.isReference||e++)},this);if(!c.length||!e)console.log("Map.setBasemap: "+q.substitute({basemapName:a},this.invalidBasemap));else{var f={basemapName:a,infos:d,layers:c};if(this.loaded){var g=this,h=new V(la._dfdCanceller),i=
function(){h._pendingLayers--;var a=j.indexOf(f.layers,this);if(-1<a&&(a=h._layerEvents[a]))u.disconnect(a[0]),u.disconnect(a[1]);0>=h._pendingLayers&&(delete h._layerEvents,delete g._basemapDfd,h.callback(f))};this._basemapDfd=h;h._pendingLayers=0;h._layerEvents={};j.forEach(c,function(a,b){a&&(h._pendingLayers++,a.loaded?i(a):h._layerEvents[b]=[u.connect(a,"onLoad",a,i),u.connect(a,"onError",a,i)])});h.addCallback(C.hitch(this,this._basemapLoaded))}else this._basemapLoaded(f)}}else{b=[];for(var k in o.basemaps)b.push(k);
console.log("Map.setBasemap: "+q.substitute({basemapName:a,list:b.join(",")},this.unknownBasemap))}},_basemapLoaded:function(a){var b=a.layers,c=a.infos,d=0,e=!0;this.loaded&&(j.forEach(b,function(a,b){a.loaded&&(c[b].isReference||d++)}),e=d);if(e)this._removeBasemap(),this._basemap=a.basemapName,this.basemapLayerIds=this._addBasemap(b,c),this._fireEvent("onBasemapChange")},_addBasemap:function(a,b){var c=[],d=[],e=0;j.forEach(a,function(a,g){b[g].isReference?c.push(a):(this.addLayer(a,e++),d.push(a.id))},
this);c.length&&j.forEach(c,function(a){this.addLayer(a,"top");d.push(a.id)},this);return d},_removeBasemap:function(){var a=this.basemapLayerIds,b;a&&a.length&&j.forEach(a,function(a){(b=this.getLayer(a))&&this.removeLayer(b)},this)},getBasemap:function(){return this._basemap||""},translate:function(a,b){a=a||0;b=b||0;if(!this._txTimer){this._tx=this._ty=0;var c=this.toScreen(this.extent.getCenter());this.__panStart(c.x,c.y)}this._tx+=a;this._ty+=b;this.__pan(this._tx,this._ty);clearTimeout(this._txTimer);
this._txTimer=setTimeout(this._endTranslate,150)},_endTranslate:function(){clearTimeout(this._txTimer);this._txTimer=null;var a=this._tx,b=this._ty;this._tx=this._ty=0;this.__panEnd(a,b)},setTimeExtent:function(a){this.timeExtent=a;this.onTimeExtentChange(a?new a.constructor(a.toJson()):null)},setTimeSlider:function(a){if(this.timeSlider)E(this._tsTimeExtentChange_connect),this.timeSlider=this._tsTimeExtentChange_connect=null;if(a)this.timeSlider=a,this.setTimeExtent(a.getCurrentTimeExtent()),this._tsTimeExtentChange_connect=
L(a,"onTimeExtentChange",this,"setTimeExtent")},setVisibility:function(a){if(this.visible!==a){this.visible=a;if(!a)this._display=this.container.style.display;this.container.style.display=a?this._display:"none";if(this.autoResize){var b=a?"resume":"pause";this._rszSignal[b]();this._oriSignal[b]()}a&&this.resize()}},resize:function(a){var b=this,c=function(){clearTimeout(b._resizeT);b.reposition();b._resize()};clearTimeout(b._resizeT);!0===a?c():b._resizeT=setTimeout(c,b.resizeDelay)},_resize:function(){var a=
this.width,b=this.height,c=O.getContentBox(this.container);if(!(a===c.w&&b===c.h)){var d=this._zoomAnim||this._panAnim;d&&(d.stop(),d._fire("onEnd",[d.node]));x(this.root,{width:(this.width=c.w)+"px",height:(this.height=c.h)+"px"});c=this.width;d=this.height;this.attribution&&this.attribution.domNode&&P.set(this.attribution.domNode,"width",Math.floor(c*this._mapParams.attributionWidth)+"px");this.__visibleRect.update(this.__visibleRect.x,this.__visibleRect.y,c,d);this.__visibleDelta.update(this.__visibleDelta.x,
this.__visibleDelta.y,c,d);var e=new I(this.extent),a=(new I(e.x,e.y,e.width*(c/a),e.height*(d/b),this.spatialReference)).getExtent();this.onResize(a,c,d);this._extentUtil(null,null,a,null,!0)}},reposition:function(){this._reposition();this.onReposition(this.position.x,this.position.y)},_reposition:function(){var a=O.position(this.container,!0),b=O.getPadBorderExtents(this.container);this.position.update(a.x+b.l,a.y+b.t)},_setClipRect:function(){delete this._clip;var a=R("ie")?"rect(auto,auto,auto,auto)":
null;if(this.wrapAround180){var b=this.width,c=this.height,d=this._getFrameWidth(),e=b-d;if(0<e)a=e/2,a="rect(0px,"+(a+d)+"px,"+c+"px,"+a+"px)",c=this.extent.getWidth(),b=c*(d/b),this._clip=[(c-b)/2,b]}x(this.__container,"clip",a)},_getAvailExtent:function(){var a=this.extent,b=this._clip;if(b){if(!a._clip){var c=new I(a);c.width=b[1];c.x+=b[0];a._clip=c.getExtent()}return a._clip}return a},_fixedPan:function(a,b){return this._extentUtil(null,{dx:a,dy:b})},panUp:function(){return this._fixedPan(0,
-0.75*this.height)},panUpperRight:function(){return this._fixedPan(0.75*this.width,-0.75*this.height)},panRight:function(){return this._fixedPan(0.75*this.width,0)},panLowerRight:function(){return this._fixedPan(0.75*this.width,0.75*this.height)},panDown:function(){return this._fixedPan(0,0.75*this.height)},panLowerLeft:function(){return this._fixedPan(-0.75*this.width,0.75*this.height)},panLeft:function(){return this._fixedPan(-0.75*this.width,0)},panUpperLeft:function(){return this._fixedPan(-0.75*
this.width,-0.75*this.height)},enableSnapping:function(a){a=a||{};if("esri.SnappingManager"===a.declaredClass)this.snappingManager=a;else{var b=aa++,c=this;this._rids&&this._rids.push(b);U(["esri/SnappingManager"],function(d){var e=c._rids?j.indexOf(c._rids,b):-1;if(-1!==e)c._rids.splice(e,1),c.snappingManager=new d(C.mixin({map:c},a))})}return this.snappingManager},disableSnapping:function(){this.snappingManager&&this.snappingManager.destroy();this.snappingManager=null}})});