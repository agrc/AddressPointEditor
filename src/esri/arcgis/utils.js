//>>built
define(["dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/Deferred","dojo/_base/json","dojo/_base/url","dojo/has","dojo/DeferredList","dojo/dom-construct","esri/kernel","esri/config","esri/lang","esri/request","esri/SpatialReference","esri/map","esri/urlUtils","esri/geometry/ScreenPoint","esri/geometry/Extent","esri/geometry/webMercatorUtils","esri/symbols/jsonUtils","esri/renderers/jsonUtils","esri/dijit/PopupTemplate","esri/dijit/Popup","esri/tasks/query","esri/tasks/GeometryService","esri/arcgis/csv","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/OpenStreetMapLayer","esri/layers/WebTiledLayer","esri/layers/FeatureLayer","esri/layers/WMSLayer","esri/layers/KMLLayer","esri/layers/GeoRSSLayer","esri/virtualearth/VETiledLayer","esri/layers/TileInfo","esri/layers/DynamicLayerInfo","esri/layers/LayerDrawingOptions","esri/layers/ImageParameters","esri/layers/ImageServiceParameters","esri/layers/RasterFunction","esri/layers/MosaicRule","esri/layers/WMSLayerInfo","dojo/i18n!esri/nls/jsapi"],
function(j,g,o,t,R,la,Ia,w,ma,C,D,h,u,r,na,oa,S,v,pa,E,qa,T,ra,sa,ta,F,U,V,ua,va,wa,p,xa,ya,za,x,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,W){function y(a){return u({url:m.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function X(a){var c={f:"json"};if(C.id){var b=C.id.findCredential(oa.urlToObject(m.arcgisUrl).path);if(b)c.token=b.token}return u({url:a,content:c,callbackParamName:"callback"},{disableIdentityLookup:!0})}function Y(a){if(a.itemProperties.layerDefinition)if(a.layerDefinition){if(!a.layerDefinition.drawingInfo)a.layerDefinition.drawingInfo=
a.itemProperties.layerDefinition.drawingInfo;if(!h.isDefined(a.layerDefinition.definitionExpression))a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression;if(!h.isDefined(a.layerDefinition.minScale))a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale;if(!h.isDefined(a.layerDefinition.maxScale))a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale}else a.layerDefinition=a.itemProperties.layerDefinition;if(a.itemProperties.popupInfo&&
!a.popupInfo&&!a.disablePopup)a.popupInfo=a.itemProperties.popupInfo}function G(a,c){var b=new t,e=a.itemData,d=[],f=[];g.forEach(e.operationalLayers,function(a){if(a.itemId&&!a.type){var b=a.url.toLowerCase();-1<b.indexOf("/featureserver")?(f.push(a),d.push(y(a))):-1<b.indexOf("/mapserver")&&-1===b.indexOf("/mapserver/")&&(!a.layers||!h.isDefined(a.minScale)&&!h.isDefined(a.maxScale))?(f.push(a),d.push(y(a))):-1<b.indexOf("/imageserver")&&!h.isDefined(a.minScale)&&!h.isDefined(a.maxScale)&&(f.push(a),
d.push(y(a)))}});e.baseMap&&e.baseMap.baseMapLayers&&g.forEach(e.baseMap.baseMapLayers,function(a){if(("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type)&&a.portalUrl)f.push(a),d.push(X(a.portalUrl))});0<d.length?(new w(d)).addCallback(function(d){g.forEach(f,function(a,b){if(("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type)&&a.portalUrl)d[b][1].bingKey?c.bingMapsKey=d[b][1].bingKey:(a.errors=a.errors||[],a.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. [type:"+
a.type+"]"}));else{var e=d[b][1];if(e){var f=a.url.toLowerCase();if(-1<f.indexOf("/featureserver")&&e.layers)g.forEach(e.layers,function(b){if(f.endsWith("/featureserver/"+b.id))a.itemProperties=b,Y(a)});else if(-1<f.indexOf("/mapserver")){if(e.layers&&!a.layers)a.layers=e.layers;if(h.isDefined(e.minScale)&&!h.isDefined(a.minScale))a.minScale=e.minScale;if(h.isDefined(e.maxScale)&&!h.isDefined(a.maxScale))a.maxScale=e.maxScale}else if(-1<f.indexOf("/imageserver")){if(h.isDefined(e.minScale)&&!h.isDefined(a.minScale))a.minScale=
e.minScale;if(h.isDefined(e.maxScale)&&!h.isDefined(a.maxScale))a.maxScale=e.maxScale}}}});b.callback(a)}):b.callback(a);return b}function I(a,c){var b=a.dynamicLayerInfos||a.layerInfos,e=c.layers;if(e&&b){var d=[],f=[],i=[];g.forEach(b,function(b){var c=b.id;if(!b.subLayerIds&&-1!==g.indexOf(a.visibleLayers,c))for(b=0;b<e.length;b++){var H=e[b];if(H.id===c){f.push(c);d.push(H.popupInfo);i.push(H.layerUrl||"");break}}});if(d.length)a.__popups=d,a.__popupIds=f,a.__popupUrls=i,a.__resourceInfo=c.resourceInfo}}
function Z(a){if(!a)return!1;var c=(new la(m.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(c)}function $(a){return!a?!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function q(a){if("https:"===location.protocol&&(Z(a)||$(a)))a=a.replace("http:","https:");return a}function J(a){var c=[];a.displayLevels||(c=g.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));c=new U(q(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,
visible:a.visibility,displayLevels:a.displayLevels||c,id:a.id,minScale:a.minScale,maxScale:a.maxScale});I(c,a);return c}function aa(a,c){if(!a||!c||0===c.length)return[];var b=","+c+",",e=[],d,f=",";for(d=0;d<a.length;d++)if(null!==a[d].subLayerIds){if(-1===b.indexOf(","+a[d].id+",")||-1<f.indexOf(","+a[d].id+","))f+=a[d].subLayerIds.toString()+","}else-1<b.indexOf(","+a[d].id+",")&&-1===f.indexOf(","+a[d].id+",")&&e.push(a[d].id);return e}function z(a){var c=new Da;c.format="png24";if(a.resourceInfo&&
a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))c.format="png32";var c=new V(q(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:c,minScale:a.minScale,maxScale:a.maxScale}),b=a.visibleLayers;if(!a.visibleLayers){var e="";g.forEach(c.layerInfos,function(a){a.defaultVisibility&&(e+=(0<e.length?",":"")+a.id)});b=e}b=aa(c.layerInfos,b);c.setVisibleLayers(b);if(a.layers&&0<a.layers.length){var d=[],
f=[],i,l=[],k;g.forEach(a.layers,function(b){if(b.layerDefinition&&b.layerDefinition.definitionExpression)d[b.id]=b.layerDefinition.definitionExpression;if(b.layerDefinition&&b.layerDefinition.source){i=new Ba(j.mixin(b,b.layerDefinition));delete i.layerDefinition;i.id=b.id;if(a.visibleLayers)i.defaultVisibility=-1<g.indexOf(a.visibleLayers,b.id)?!0:!1;f.push(i)}b.layerDefinition&&b.layerDefinition.source&&b.layerDefinition.drawingInfo&&(k=new Ca(b.layerDefinition.drawingInfo),l[b.id]=k)},this);0<
d.length&&c.setLayerDefinitions(d);0<f.length&&(c.setDynamicLayerInfos(f,!0),0<l.length&&c.setLayerDrawingOptions(l,!0))}I(c,a);return c}function ba(a,c){var b=[102113,102100,3857],e=new r(c[0].layerObject.fullExtent.spatialReference),d=new r(a.resourceInfo.fullExtent.spatialReference);return e.wkt==d.wkt&&(e.wkid==d.wkid||esri.isDefined(e.latestWkid)&&e.latestWkid==d.wkid||esri.isDefined(d.latestWkid)&&e.wkid==d.latestWkid||esri.isDefined(e.latestWkid)&&e.latestWkid==d.latestWkid)||e.wkid&&d.wkid&&
g.some(b,function(a){return a===d.wkid})&&g.some(b,function(a){return a===e.wkid})?!0:!1}function ca(a,c){if(!c[0].layerObject.tileInfo)return!1;var b=[];g.forEach(c,function(a){a.baseMapLayer&&a.layerObject.tileInfo&&(b=b.concat(g.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});return g.some(a.resourceInfo.tileInfo.lods,function(a){return g.some(b,function(b){return b===a.scale})})}function K(a,c,b,e){var d,f=b._clazz;if("OpenStreetMap"===a.type)d=new va({id:a.id,opacity:a.opacity,
visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WMS"===a.type){var i=[],l=[];g.forEach(a.layers,function(a){l.push(new Ha({name:a.name,title:a.title,legendURL:a.legendURL}));i.push(a.name)},this);if(a.visibleLayers)i=a.visibleLayers;f={extent:new v(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new r({wkid:4326})),layerInfos:l,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,getMapUrl:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,
copyright:a.copyright};d=new xa(a.url,{id:a.id,visibleLayers:i,format:"png",transparent:a.baseMapLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:f});d.spatialReference.wkid=f.spatialReferences[0]}else if("KML"===a.type)d=new ya(a.url,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:e}),o.connect(d,"onLoad",function(){var b=function(c){g.forEach(c,function(c){"esri.layers.FeatureLayer"===c.declaredClass||"esri.layers.MapImageLayer"===c.declaredClass?
c.setOpacity(a.opacity):"esri.layers.KMLLayer"===c.declaredClass&&(c.loaded?b(c.getLayers()):o.connect(c,"onLoad",j.hitch(this,function(a){b(a.getLayers())})))})};(a.opacity||0===a.opacity)&&b(d.getLayers());a.visibleFolders&&g.forEach(d.folders,function(b){-1<g.indexOf(a.visibleFolders,b.id)?d.setFolderVisibility(b,!0):d.setFolderVisibility(b,!1)},this)});else if("WebTiledLayer"===a.type)d=new wa(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,
fullExtent:a.fullExtent&&new v(a.fullExtent),initialExtent:a.fullExtent&&new v(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Aa(a.tileInfo):null}),o.connect(d,"onLoad",function(){(h.isDefined(a.minScale)||h.isDefined(a.maxScale))&&d.setScaleRange(a.minScale,a.maxScale)});else if("GeoRSS"===a.type)d=new za(a.url,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,outSpatialReference:e}),o.connect(d,"onLoad",function(){var b=d.getFeatureLayers();g.forEach(b,function(b){if(a.pointSymbol&&
"esriGeometryPoint"===b.geometryType)b.renderer.symbol=E.fromJson(a.pointSymbol);else if(a.lineSymbol&&"esriGeometryPolyline"===b.geometryType)b.renderer.symbol=E.fromJson(a.lineSymbol);else if(a.polygonSymbol&&"esriGeometryPolygon"===b.geometryType)b.renderer.symbol=E.fromJson(a.polygonSymbol);(h.isDefined(a.minScale)||h.isDefined(a.maxScale))&&b.setScaleRange(a.minScale,a.maxScale)})});else if("CSV"==a.type&&a.url)d=new p(a.featureCollection,{infoTemplate:new T(a.popupInfo?a.popupInfo:F.generateDefaultPopupInfo(a.featureCollection)),
id:a.id?a.id:null,outFields:["*"],visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,autoGeneralize:!0});else if(a.layerDefinition&&!a.url)b=R.fromJson(R.toJson(a)),delete b.id,delete b.opacity,delete b.visibility,d=new p(b,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],infoTemplate:b.popupInfo&&new f(b.popupInfo),autoGeneralize:!0});else if("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type){if(b.bingMapsKey){f=x.MAP_STYLE_AERIAL_WITH_LABELS;
if("BingMapsAerial"===a.type)f=x.MAP_STYLE_AERIAL;else if("BingMapsRoad"===a.type)f=x.MAP_STYLE_ROAD;d=new x({bingMapsKey:b.bingMapsKey,mapStyle:f,opacity:a.opacity,id:a.id})}}else if(a.resourceInfo&&a.resourceInfo.mapName)d=!0===a.resourceInfo.singleFusedMapCache?a.baseMapLayer?J(a):ba(a,c)?ca(a,c)?J(a):z(a):z(a):z(a);else if(a.resourceInfo&&a.resourceInfo.pixelSizeX){b=new Ea;b.bandIds=a.bandIds;if(null!=a.format&&(b.format=a.format,null!=a.compressionQuality))b.compressionQuality=a.compressionQuality;
if(a.renderingRule&&a.renderingRule.rasterFunction)c=new Fa(a.renderingRule),b.renderingRule=c;if(a.mosaicRule)c=new Ga(a.mosaicRule),b.mosaicRule=c;if(h.isDefined(a.noData))b.noData=a.noData;if(h.isDefined(a.noDataInterpretation))b.noDataInterpretation=a.noDataInterpretation;if(h.isDefined(a.interpolation))b.interpolation=a.interpolation;d=new ua(q(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:b,infoTemplate:a.popupInfo&&new f(a.popupInfo),
minScale:a.minScale,maxScale:a.maxScale});a.layerDefinition&&a.layerDefinition.definitionExpression&&d.setDefinitionExpression(a.layerDefinition.definitionExpression,!0)}else if(a.resourceInfo&&"Feature Layer"===a.resourceInfo.type&&(d=new p(q(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:h.isDefined(a.mode)?a.mode:p.MODE_ONDEMAND,outFields:["*"],infoTemplate:a.popupInfo&&new f(a.popupInfo),autoGeneralize:!0}),a.layerDefinition)){if(a.layerDefinition.drawingInfo&&
a.layerDefinition.drawingInfo.renderer)f=qa.fromJson(a.layerDefinition.drawingInfo.renderer),f.isMaxInclusive=!0,d.setRenderer(f);a.layerDefinition.definitionExpression&&d.setDefinitionExpression(a.layerDefinition.definitionExpression);h.isDefined(a.layerDefinition.minScale)&&d.setMinScale(a.layerDefinition.minScale);h.isDefined(a.layerDefinition.maxScale)&&d.setMaxScale(a.layerDefinition.maxScale)}if(d&&(d.arcgisProps={title:a.title},a.baseMapLayer))d._basemapGalleryLayerType=a.isReference?"reference":
"basemap";return d}function A(a,c,b){g.forEach(a,function(d,e){if(d.url&&!d.type){if(0===e||a[0].layerObject)d.layerObject=K(d,a,c,b)}else d.layerObject=K(d,a,c,b)});var e=g.filter(a,function(a){return!a.isReference}),d=g.filter(a,function(a){return!!a.isReference});return a=e.concat(d)}function L(a){var c=null,a=a[0];if(a.url&&!a.type){if(a.resourceInfo.spatialReference){c=new r;if(a.resourceInfo.spatialReference.wkid)c.wkid=a.resourceInfo.spatialReference.wkid;if(a.resourceInfo.spatialReference.wkt)c.wkt=
a.resourceInfo.spatialReference.wkt}}else-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?c=new r({wkid:102100}):"WMS"==a.type&&(c=new r({wkid:a.spatialReferences[0]}));return c}function da(a,c,b,e,d){g.forEach(c,function(b){if(b.url&&!b.type)b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos;else if(b.url&&"CSV"==b.type)b.featureCollection=e[b.deferredsPos].results[0],delete b.deferredsPos});var f=L(c),i=[];new t;g.forEach(c,function(a){if(a.url&&"CSV"==a.type)a.deferredsPos=i.length,
i.push(F.projectFeatureCollection(a.featureCollection,f))});0==i.length?(c=A(c,b,f),d.callback(c)):(new w(i)).addCallback(function(){g.forEach(c,function(a){if(a.url&&"CSV"==a.type)a.featureCollection=i[a.deferredsPos].results[0],delete a.deferredsPos});c=A(c,b,f);d.callback(c)})}function ea(a,c){var b=q(a);return u({url:b,content:{f:"json"},callbackParamName:"callback",error:function(a,d){a.message=a.message?a.message+(" [url:"+b+"]"):"[url:"+b+"]";c.push(a);D.defaults.io.errorHandler(a,d)}})}function M(a,
c){var b=[],e=[],d=[],f=new t;g.forEach(a.operationalLayers,function(a,b){a.featureCollection?g.forEach(a.featureCollection.layers,function(c,e){var f=!0;a.visibleLayers&&-1==g.indexOf(a.visibleLayers,e)&&(f=!1);c.visibility=a.visibility&&f;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+e;d.push(c)},this):d.push(a)});g.forEach(a.baseMap.baseMapLayers,function(a,c){a.baseMapLayer=!0;a.id=a.id||"base"+c;b.push(a)});g.forEach(d,function(a,c){a.id=a.id||"operational"+c;b.push(a)});g.forEach(b,function(a){if(a.url&&
!a.type)a.deferredsPos=e.length,a.errors=[],e.push(ea(a.url,a.errors));else if(a.url&&"CSV"==a.type)a.deferredsPos=e.length,e.push(F.buildCSVFeatureCollection(a))});if(0==e.length){var i=L(b),b=A(b,c,i);f.callback(b)}else(new w(e)).addCallback(function(a){da(a,b,c,e,f)});return f}function N(a,c){if(10.1>=c.version&&a){var b,e=parseInt(c.url.substring(c.url.lastIndexOf("/")+1,c.url.length));for(b=a.length-1;0<=b;b--)if(a[b].id==e){if(0==c.minScale&&0<a[b].minScale)c.minScale=a[b].minScale;else if(0<
c.minScale&&0==a[b].minScale)c.minScale=c.minScale;else if(0<c.minScale&&0<a[b].minScale)c.minScale=Math.min(c.minScale,a[b].minScale);c.maxScale=Math.max(c.maxScale||0,a[b].maxScale||0);if(-1<a[b].parentLayerId)e=a[b].parentLayerId;else break}}}function B(a,c,b,e){var d=a.url,f=a.__popupIds,i=a.__popupUrls,l=a.__resourceInfo,k=[];g.forEach(a.__popups,function(e,h){if(e){var n,O=[];g.forEach(e.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&O.push(a.fieldName)});if(a.dynamicLayerInfos&&
0<a.dynamicLayerInfos.length)n=g.filter(a.dynamicLayerInfos,function(a){return f[h]==a.id})[0].source,n=new p(d+"/dynamicLayer",{id:a.id+"_"+f[h],source:n,outFields:O,mode:p.MODE_SELECTION,infoTemplate:e&&new b(e),drawMode:!1,visible:a.visible,autoGeneralize:!0});else{var j;n=null;if(c)for(j=0;j<c.length;j++)if(c[j].id===f[h]){n=c[j];break}j=d+"/"+f[h];i[h].length&&(j=i[h]);n=new p(q(j),{id:a.id+"_"+f[h],outFields:O,mode:p.MODE_SELECTION,infoTemplate:e&&new b(e),drawMode:!1,visible:a.visible,resourceInfo:n,
autoGeneralize:!0})}n.loaded?n.setScaleRange(a.minScale,a.maxScale):o.connect(n,"onLoad",function(b){b.setScaleRange(a.minScale,a.maxScale)});n.loaded?N(l.layers,n):o.connect(n,"onLoad",function(a){N(l.layers,a)});k.push(n)}});0<k.length&&(o.connect(a,"onVisibilityChange",j.hitch(this,function(a,b){g.forEach(a,function(a){b?a.show():a.hide()})},k)),o.connect(e,"onLayerRemove",j.hitch(this,function(a,b,c){a.id===c.id&&g.forEach(b,function(a){e.removeLayer(a)})},a,k)));delete a.__popups;delete a.__popupIds;
delete a.__popupUrls;delete a.__resourceInfo;return k}function fa(a){return u({url:q(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function ga(a,c,b){var e=[];g.forEach(a,function(a){var b=a.__popups;if(b&&1<b.length&&10<=a.version)a.__deferredsPos=e.length,e.push(fa(a))});var d=[];0<e.length?(new w(e)).addCallback(function(e){g.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(d=d.concat(B(a,e[a.__deferredsPos][1].layers,
b,c)),delete a.__deferredsPos):d=d.concat(B(a,null,b,c)))});c.addLayers(d)}):(g.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(d=d.concat(B(a,null,b,c)))}),c.addLayers(d))}function ha(a){g.forEach(a,function(a){var b=a.layer;b.toJson&&(a=b.toJson(),a.featureSet&&-1<b.name.indexOf("Text")&&g.forEach(a.featureSet.features,function(a,c){if(a.attributes.TEXT){var f=b.graphics[c];f.symbol.setText(a.attributes.TEXT);if(a.symbol.horizontalAlignment)f.symbol.align=a.symbol.horizontalAlignment;f.setSymbol(f.symbol);
f.setAttributes(a.attributes)}},this))})}function ia(a){var c=6;g.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(c=Math.max(c,Math.abs(a.xoffset))),a&&a.yoffset&&(c=Math.max(c,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&g.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(c=Math.max(c,Math.abs(a.xoffset)));a&&a.yoffset&&(c=Math.max(c,Math.abs(a.yoffset)))})});
return c}function P(a){var c=this,b=c.infoWindow,e=a.graphic;if(c.loaded){b.hide();b.clearFeatures();var d=[];g.forEach(c.graphicsLayerIds,function(a){if((a=c.getLayer(a))&&-1!==a.declaredClass.indexOf("FeatureLayer")&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&d.push(a)});g.forEach(c.layerIds,function(a){(a=c.getLayer(a))&&-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate&&d.push(a)});e=e&&e.getInfoTemplate()?e:null;if(d.length||
e){var f=ia(d),i=a.screenPoint,h=c.toMap(new S(i.x-f,i.y+f)),f=c.toMap(new S(i.x+f,i.y-f)),h=new v(h.x,h.y,f.x,f.y,c.spatialReference),k=new sa;k.geometry=h;k.timeExtent=c.timeExtent;var j=!0,h=g.map(d,function(a){var b;-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?(j=!1,b=a.queryVisibleRasters(k,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),b.addCallback(function(){return a.getVisibleRasters()})):(b=a.selectFeatures(k),b.addCallback(function(){return a.getSelectedFeatures()}));
return b});e&&(f=new t,f.callback([e]),h.splice(0,0,f));if(!g.some(h,function(a){return-1===a.fired})){var m=e?1:0;g.forEach(d,function(a){m=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?m+a.getVisibleRasters().length:m+a.getSelectedFeatures().length});if(!m)return}b.setFeatures(h);b.show(a.mapPoint,{closestFirst:j})}}}function s(a,c,b,e,d,f){var i=d.mapOptions||{},l,k;if(!i.infoWindow)l=new ra(null,ma.create("div")),i.infoWindow=l;if(!h.isDefined(i.showInfoWindowOnClick))i.showInfoWindowOnClick=
!1;e=new na(e,i);d.ignorePopups&&g.forEach(a,function(a){delete a.infoTemplate});!d.ignorePopups&&!d.disableClickBehavior&&(k=o.connect(e,"onClick",P));o.connect(e,"onLayersAddResult",ha);e.addLayers(a);d.ignorePopups||ga(a,e,d._clazz);var j=[];g.forEach(c,function(a){j=j.concat(a.errors)},this);f.callback({map:e,itemInfo:b,errors:j,clickEventHandle:k,clickEventListener:P})}function Q(a,c,b,e,d){try{var f=b.mapOptions||{};b.mapOptions=f;var i=a.item,l=[];g.forEach(d,function(a){j.isArray(a.layerObject)?
g.forEach(a.layerObject,function(a){l.push(a)}):l.push(a.layerObject)});if(l[0])if(l=g.filter(l,h.isDefined),i)if(i.extent)if(f.extent)s(l,d,a,c,b,e);else{var k=new v(i.extent[0][0],i.extent[0][1],i.extent[1][0],i.extent[1][1],new r({wkid:4326})),m=l[0].spatialReference;4326===m.wkid?(f.extent=k,s(l,d,a,c,b,e)):102100===m.wkid||102113===m.wkid||3857===m.wkid?(k.xmin=Math.max(k.xmin,-180),k.xmax=Math.min(k.xmax,180),k.ymin=Math.max(k.ymin,-89.99),k.ymax=Math.min(k.ymax,89.99),f.extent=pa.geographicToWebMercator(k),
s(l,d,a,c,b,e)):b.geometryServiceURL||D.defaults.geometryService?(b.geometryServiceURL?new ta(b.geometryServiceURL):D.defaults.geometryService).project([k],m,function(g){g=g[0];f.extent=f.extent||g;s(l,d,a,c,b,e)}):e.errback(Error(W.arcgis.utils.geometryServiceError))}else s(l,d,a,c,b,e);else s(l,d,a,c,b,e);else i="",d[0].errors&&d[0].errors.length&&(i=" ("+d[0].errors[0].message+")"),e.errback(Error(W.arcgis.utils.baseLayerError+i))}catch(o){e.errback(o)}}function ja(a){var c=[],a=a.baseMap.baseMapLayers.concat(a.operationalLayers);
g.forEach(a,function(a){var e={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&g.forEach(a.featureCollection.layers,function(d){!1!==d.showLegend&&(e={layer:d.layerObject,title:a.title,defaultSymbol:d.renderer&&d.renderer.defaultSymbol&&d.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(e.title+=" - "+d.layerDefinition.name),c.push(e))});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var d=
a.layerObject.renderer,d=!d||d&&d.defaultSymbol&&d.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&(a.layerObject instanceof V||a.layerObject instanceof U)||a.layerObject instanceof esri.layers.ArcGISImageServiceLayer)d=!0;e={layer:a.layerObject,title:a.title,defaultSymbol:d};if(a.layers&&(d=g.map(g.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),d.length))e.hideLayers=d;c.push(e)}});return c}function ka(a){if(m._arcgisUrl&&0<m._arcgisUrl.length)m.arcgisUrl=m._arcgisUrl;
var c=m.arcgisUrl+"/"+a,b={},e=new t;u({url:c,content:{f:"json"},callbackParamName:"callback",load:function(a){b.item=a;u({url:c+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){b.itemData=a;e.callback(b)},error:function(a){e.errback(a)}})},error:function(a){e.errback(a)}});return e}String.prototype.endsWith=function(a){return this.match(a+"$")==a};var m;m={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:ka,createMap:function(a,c,b){var e=
new t,b=b||{},d=b.infoTemplateClass;b._clazz=d&&(j.isObject(d)?d:j.getObject(d))||T;j.isString(a)?ka(a).addCallback(function(a){G(a,b).addCallback(function(a){M(a.itemData,b).addCallback(j.hitch(null,Q,a,c,b,e))})}).addErrback(j.hitch(e,e.errback)):G(a,b).addCallback(function(a){M(a.itemData,b).addCallback(j.hitch(null,Q,a,c,b,e))});return e},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?ja(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:G,_getItemData:y,_getBingKey:X,
_processFSItemProperties:Y,_getLayers:M,_preBuildLayerObjects:da,_buildLayerObjects:A,_preCreateMap:Q,_getMapSR:L,_createMap:s,_addSelectionLayers:ga,_createSelectionFeatureLayers:B,_getServiceInfo:ea,_getLayersInfo:fa,_initLayer:K,_loadAsCached:J,_loadAsDynamic:z,_processPopups:I,_onLayersAddResult:ha,_sameSpatialReferenceAsBasemap:ba,_sameTilingSchemeAsBasemap:ca,_showPopup:P,_calculateClickTolerance:ia,_getVisibleFeatureLayers:aa,_updateLayerScaleInfo:N,_checkUrl:q,_isHostedService:Z,_isAgolService:$,
_getLegendLayers:ja};j.setObject("arcgis.utils",m,C);return m});